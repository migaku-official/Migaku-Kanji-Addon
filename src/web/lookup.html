<!-- ======================
START - Migaku markup
- @version v0.6.1
======================= -->

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<div id="welcome">
	<div class="KanjiLookup-container KanjiLookup-container--noResult">
		<h1 class="welcome">WELCOME!</h1>
		<p class="welcome-text">
			To look up Kanji, enter them into the box above and press Enter or press
			the search button.
		</p>
		<p class="welcome-text">
			You can also press <span class="key">CTRL</span> +
			<span class="key">SHIFT</span> + <span class="key">K</span> anywhere in
			Anki to search for the highlighted characters.
		</p>
	</div>
</div>

<div id="noresult" style="display: none">
	<div class="KanjiLookup-container KanjiLookup-container--noResult">
		<h1>No result found for character</h1>
		<h1 class="kanji">仮</h1>
	</div>
</div>

<div id="result" style="display: none">
	<!-- START - Migaku header -->
	<div class="migaku-header">
		<img class="migaku-header__logo" src="/_migaku-logo.svg" alt="Logo" />
	</div>
	<!-- END - Migaku header -->

	<div class="layout__container">
		<div class="layout__above"></div>

		<main class="layout__main">
			<div class="layout__content">
				<!-- START - Font examples -->
				<div class="font-examples__container">
					<h2 class="vh">Font examples</h2>
					<ul class="font-examples__list">
						<li class="fontExample font-examples__character"></li>
						<li class="fontExample font-examples__character"></li>
						<li class="fontExample font-examples__character"></li>
						<li class="fontExample font-examples__character"></li>
					</ul>
				</div>
				<!-- END - Font examples -->

				<!-- START - Keyword and meaning -->
				<div class="keyword-and-meaning__container">
					<h2 id="keywords" class="keyword-and-meaning__keyword"></h2>

					<div class="meanings__container">
						<h3 class="meanings__title">Meanings:</h3>
						<span id="meanings"></span>
					</div>
				</div>
				<!-- END - Keyword and meaning -->

				<!-- START - Linked words -->
				<div class="linked-words__container">
					<h2 class="-has-separator">Appears in</h2>
					<div class="linked-words__examples">
						<div id="words" class="linked-words__list"></div>
					</div>
					<div class="linked-words__mobile">
						Linked words are only clickable on desktop.
					</div>
				</div>
				<!-- END - Linked words -->

				<!-- START - Primitives and radicals -->
				<div class="primitives-and-radicals__wrapper">
					<div class="primitives-and-radicals__container">
						<div class="primitives-and-radicals__block">
							<h2 class="primitives-and-radicals__title -has-separator">
								Primitives
							</h2>
							<div id="primitives" class="primitives-and-radicals__list"></div>
						</div>
						<div class="primitives-and-radicals__block">
							<h2 class="primitives-and-radicals__title -has-separator">
								Radicals
							</h2>
							<div id="radicals" class="primitives-and-radicals__list"></div>
						</div>
					</div>
					<div class="primitives-and-radicals__mobile">
						Primitives and radicals are only clickable on desktop.
						<br />
						Only primitive tooltips are visible on mobile.
					</div>
				</div>
				<!-- END - Primitives and radicals -->

				<!-- START - Actions lookup -->
				<div class="lookup-actions__container">
					<h2 class="-has-separator">Cards</h2>
					<div class="lookup-actions__buttons">
						<button
							onclick="recognition_card_click(event);"
							id="recognition_card_btn"
							class="button -wide"
							title="null"
						>
							Show Recognition Card
						</button>
						<button
							onclick="production_card_click(event);"
							id="production_card_btn"
							class="button -wide"
							title="Shift click to mark as known"
						>
							Create Production Card
						</button>
					</div>
					<div class="lookup-actions__mobile">
						Actions only work on desktop.
						<br />
						You are able to mark a kanji as known, and create or show the
						associated recognition and production cards.
					</div>
				</div>
				<!-- END - Actions lookup -->
			</div>

			<aside class="layout__aside">
				<!-- START - Stroke order diagram -->
				<div class="stroke-order-diagram__container">
					<hr class="separator -full" />

					<h2 class="vh">Character</h2>
					<div class="stroke-order-diagram__player">
						<button
							id="toggle_strokeorder_numbers"
							type="button"
							class="
								stroke-order-diagram__settings-button
								stroke-order-diagram__toggle-strokeorder-numbers
							"
							title="Toggle stroke order numbers"
						>
							<img
								src="/_kanji_icon_numbers_on_black.svg"
								class="-numbers-on"
								alt=""
							/>
							<img
								src="/_kanji_icon_numbers_off_black.svg"
								class="-numbers-off"
								alt=""
							/>
						</button>
						<button
							role="tooltip"
							type="button"
							class="
								stroke-order-diagram__settings-button
								stroke-order-diagram__settings-tooltip
								kanji-addon__hover-tooltip-btn
							"
						>
							<img src="/_kanji_icon_cog_black.svg" alt="Settings" />
							<div class="kanji-addon__hover-tooltip -below">
								Options for autoplay and stroke number default on/off are in the
								Kanji Setting menu window.
								<br /><br />
								Tip: use arrow keys to navigate stroke order, plus ctrl for
								start/end.
							</div>
						</button>

						<span aria-hidden="true" class="stroke-order-diagram__inner-title"
							>Stroke order</span
						>

						<div class="stroke-order-diagram__character">
							<div class="stroke-order-diagram__canvas">
								<!-- Stroke order diagram is injected into the below div -->

								<div id="strokeorder"></div>

								<div class="stroke-order-diagram__axes"></div>
							</div>

							<span class="stroke-order-diagram__no-data" aria-hidden="true"
								>(no data)</span
							>
						</div>

						<div class="stroke-order-diagram__controls">
							<div class="stroke-order-diagram__buttons">
								<button
									id="strokeorder_start"
									disabled="disabled"
									data-disable-while-playing
									data-disable-while-drawing
								>
									<img
										src="/_kanji_icon_skip_start_black.svg"
										alt="Start skip"
									/>
								</button>
								<button
									id="strokeorder_prev"
									disabled="disabled"
									data-disable-while-playing
									data-disable-while-drawing
								>
									<img src="/_kanji_icon_previous_black.svg" alt="Previous" />
								</button>
								<div class="stroke-order-diagram__play-pause-container">
									<button
										id="strokeorder_pause"
										disabled="disabled"
										class="-hide"
										data-disable-while-erasing
										data-disable-while-drawing
									>
										<img src="/_kanji_icon_pause_black.svg" alt="Pause" />
									</button>
									<button
										id="strokeorder_play"
										disabled="disabled"
										data-disable-while-playing
										data-disable-while-drawing
										data-disable-while-erasing
									>
										<img src="/_kanji_icon_play_black.svg" alt="Play" />
									</button>
									<button
										id="strokeorder_replay"
										disabled="disabled"
										class="-hide"
										data-disable-while-playing
										data-disable-while-drawing
										data-disable-while-erasing
									>
										<img src="/_kanji_icon_replay_black.svg" alt="Replay" />
									</button>
								</div>
								<button
									id="strokeorder_next"
									disabled="disabled"
									data-disable-while-playing
									data-disable-while-erasing
								>
									<img src="/_kanji_icon_next_black.svg" alt="Next" />
								</button>
								<button
									id="strokeorder_end"
									disabled="disabled"
									data-disable-while-playing
									data-disable-while-erasing
								>
									<img src="/_kanji_icon_skip_end_black.svg" alt="End skip" />
								</button>
							</div>

							<div class="stroke-order-diagram__slider">
								<input
									id="strokeorder_slider"
									disabled="disabled"
									type="range"
									min="0"
									step="1"
									data-disable-while-playing
									data-disable-while-drawing
									data-disable-while-erasing
								/>
								<div class="stroke-order-diagram__slider-notches"></div>
							</div>
						</div>
					</div>
				</div>
				<!-- END - Stroke order diagram -->

				<!-- START - Tags -->
				<div class="tags tags__container"></div>
				<!-- END - Tags -->

				<!-- START - Readings -->
				<div class="readings__container">
					<h2 class="vh">Readings</h2>
					<ul class="readings__list">
						<li>
							<strong>Onyomi:</strong>
							<span id="onyomi"></span>
						</li>
						<li>
							<strong>Kunyomi:</strong>
							<span id="kunyomi"></span>
						</li>
						<li>
							<strong>Nanori:</strong>
							<span id="nanori"></span>
						</li>
					</ul>
				</div>
				<!-- END - Readings -->
			</aside>
		</main>

		<div class="layout__below">
			<!-- START - Stories -->
			<div class="stories__container">
				<hr class="separator -full" />

				<h2 class="stories__title -has-separator">Stories</h2>
				<div id="stories" class="stories__content"></div>
			</div>
			<!-- END - Stories -->

			<!-- START - Actions -->
			<div class="actions__container">
				<h2 class="-has-separator">Actions</h2>
				<div class="actions__buttons">
					<div class="actions__set-custom">
						<button onclick="set_custom_keyword();" class="button -wide">
							Set Custom Keyword
						</button>
						<button onclick="set_custom_story();" class="button -wide">
							Set Custom Story
						</button>
					</div>
				</div>
				<div class="actions__mobile">
					Actions only work on desktop.
					<br />
					You are able to set a custom keyword, custom story, and
					mark-known/delete existing kanji cards.
				</div>
			</div>
			<!-- END - Actions -->
		</div>

		<!-- START - Migaku data -->
		<div id="migaku_data">{{MigakuData}}</div>
		<!-- START - Migaku end -->
	</div>
</div>

<!-- START - Addon script, Lookup -->
<!-- NOTE: Includes changes around DMAK -->
<script>
	let dmak = null;
	let data = null;
	let last_character = null;

	function wrap_list(list, intro, outro, dash_on_empty = true) {
		if (list.length < 1) return dash_on_empty ? '-' : '';
		return intro + list.join(outro + intro) + outro;
	}

	function search(text) {
		pycmd('open-' + text);
	}

	function search_dict(text) {
		pycmd('search_dict-' + text);
	}

	function show_word_notes(notes) {
		pycmd('show_word-' + notes.join(','));
	}

	function primitive_click() {
		search($(this).data('character'));
	}

	function word_click(evt) {
		if (evt.shiftKey) {
			search_dict($(this).data('word-kanji'));
		} else {
			var word_idx = $(this).data('word-idx');

			if (word_idx === undefined) return;

			var idx = parseInt(word_idx);

			const we = data.words[idx];
			const nids = we[2];

			show_word_notes(nids);
		}
	}

	function recognition_card_click(evt) {
		if (data.recognition_card_id !== null) {
			if (data.recognition_card_id < 0)
				pycmd('mark-recognition-' + data.character + '-0');
			else pycmd('show_card_id-' + data.recognition_card_id);
		} else {
			if (evt.shiftKey) pycmd('mark-recognition-' + data.character + '-1');
			else pycmd('create-recognition-' + data.character);
		}
	}

	// Isn't copy paste code because you are lazy fun?
	function production_card_click(evt) {
		if (data.production_card_id !== null) {
			if (data.production_card_id < 0)
				pycmd('mark-production-' + data.character + '-0');
			else pycmd('show_card_id-' + data.production_card_id);
		} else {
			if (evt.shiftKey) pycmd('mark-production-' + data.character + '-1');
			else pycmd('create-production-' + data.character);
		}
	}

	function set_custom_keyword() {
		pycmd(
			'custom_keyword-' +
				data.character +
				'-' +
				(data.usr_keyword ? data.usr_keyword : ''),
		);
	}

	function set_custom_story() {
		pycmd(
			'custom_story-' +
				data.character +
				'-' +
				(data.usr_story ? data.usr_story : ''),
		);
	}

	// ==================================================================
	// CHANGES - START - variables and control binds

	var strokeElementId = 'strokeorder',
		toggleStrokeNumberClass = '-show-stroke-numbers',
		hidePlayPauseClass = '-hide',
		$strokePlayerContainer = $('.stroke-order-diagram__player'),
		$strokeSvgContainer = $('#' + strokeElementId),
		$toggleStrokeNumber = $('#toggle_strokeorder_numbers'),
		$notchContainer = $('.stroke-order-diagram__slider-notches'),
		$slider = $('#strokeorder_slider'),
		$playButton = $('#strokeorder_play'),
		$pauseButton = $('#strokeorder_pause'),
		$replayButton = $('#strokeorder_replay'),
		$skipStartButton = $('#strokeorder_start'),
		$skipEndButton = $('#strokeorder_end'),
		$prevButton = $('#strokeorder_prev'),
		$nextButton = $('#strokeorder_next');

	function disableControls(selector) {
		var _$els = $(selector);

		_$els.each(function (idx, _el) {
			$(_el).prop('disabled', true);
		});
	}

	function enableControls(selector) {
		var _$els = $(selector);

		_$els.each(function (idx, _el) {
			$(_el).prop('disabled', false);
		});
	}

	function toggleControls(timeoutArray, selector) {
		var _$els = $(selector),
			isIdle = timeoutArray.length === 0;

		if (isIdle) {
			enableControls(selector);
		} else {
			disableControls(selector);
		}
	}

	function toggleStrokeOrderNumberVisibility() {
		$strokePlayerContainer.toggleClass(toggleStrokeNumberClass);
	}

	function clickIfNotDisabled(_$el) {
		if (_$el.prop('disabled') === false) _$el.click();
	}

	// "Default show stroke order numbers" in Kanji Settings window
	if (settings.stroke_order_show_numbers) {
		// Note default class arrangement is as per `defaultShow=false`
		toggleStrokeOrderNumberVisibility();
	}

	// Control button binds
	$playButton.click(function () {
		dmak.render();
	});
	$pauseButton.click(function () {
		$(this).prop('disabled', true);
		dmak.pause();
	});
	$replayButton.click(function () {
		dmak.replay();
	});
	$prevButton.click(function () {
		dmak.eraseLastStrokes(1);
	});
	$nextButton.click(function () {
		dmak.renderNextStrokes(1);
	});
	$skipStartButton.click(function () {
		dmak.erase();
	});
	$skipEndButton.click(function () {
		dmak.render(dmak.strokes.length, true);
	});

	// Keyboard/hotkey binds for stroke diagram navigation
	$(document).on('keyup', function (e) {
		// Left arrow key
		if (e.which === 37) {
			if (e.ctrlKey) {
				clickIfNotDisabled($skipStartButton);
			} else {
				clickIfNotDisabled($prevButton);
			}

			// Right arrow key
		} else if (e.which === 39) {
			if (e.ctrlKey) {
				clickIfNotDisabled($skipEndButton);
			} else {
				clickIfNotDisabled($nextButton);
			}
		}
	});

	// Toggle stroke order number visibility
	$toggleStrokeNumber.on('click', toggleStrokeOrderNumberVisibility);

	// CHANGES - END - variables and control binds
	// ==================================================================

	function set_data(data_b64_json) {
		var data_json = atob(data_b64_json);
		data = JSON.parse(data_json);

		// Scroll up if new character was opened
		var new_character =
			data !== null && data.has_result ? data.character : null;
		if (last_character === null || new_character != last_character)
			window.scrollTo(0, 0);
		last_character = new_character;

		// Suspend existing dmak instance
		if (dmak !== null) {
			dmak.cancel_prepare = true;
			delete dmak;
		}

		$('#welcome').toggle(data === null);
		$('#noresult').toggle(data !== null && !data.has_result);
		$('#result').toggle(data !== null && data.has_result);

		if (data !== null && !data.has_result) $('.kanji').html(data.character);
		else if (data !== null && data.has_result) {
			$('#strokeorder').html('');

			// ==================================================================
			// CHANGES - START - stroke order diagram

			dmak = new Dmak(data.character, {
				element: strokeElementId,
				uri: kanjivg_uri,
				height: 220,
				width: 220,
				step: 0.015,

				// Always false - "autoplay" default/variable is set below
				autoplay: false,

				// Always on - toggled via CSS (and default set below)
				stroke: { order: { visible: true } },

				// Grid is manually drawn in CSS instead
				grid: { show: false },

				startedErasing: function (strokeNum) {
					// Keep slider value up to date
					$slider.val(dmak.pointer);
					$slider.data('prev', dmak.pointer);

					disableControls('[data-disable-while-erasing]');

					if (strokeNum === 0) {
						$prevButton.prop('disabled', true);
						$skipStartButton.prop('disabled', true);
					}
				},
				finishedErasing: function (strokeNum) {
					enableControls('[data-disable-while-erasing]');

					if (strokeNum === dmak.strokes.length) {
						$playButton.addClass(hidePlayPauseClass);
						$replayButton.removeClass(hidePlayPauseClass);
					} else {
						$playButton.removeClass(hidePlayPauseClass);
						$replayButton.addClass(hidePlayPauseClass);
					}
				},
				startedDrawing: function (strokeNum) {
					// Keep slider value up to date
					$slider.val(strokeNum);
					$slider.data('prev', strokeNum);

					$replayButton.addClass(hidePlayPauseClass);

					if (dmak.state.isRenderingSequential) {
						$playButton.addClass(hidePlayPauseClass);
						$pauseButton.removeClass(hidePlayPauseClass);
						$pauseButton.prop('disabled', false);

						disableControls('[data-disable-while-playing]');
					} else {
						$playButton.removeClass(hidePlayPauseClass);
						$pauseButton.addClass(hidePlayPauseClass);

						disableControls('[data-disable-while-drawing]');
					}

					if (strokeNum === dmak.strokes.length) {
						$nextButton.prop('disabled', true);
						$skipEndButton.prop('disabled', true);
					}
				},
				finishedDrawing: function () {
					if (dmak.state.wasRenderingSequential) {
						toggleControls(dmak.timeouts.play, '[data-disable-while-playing]');

						$nextButton.prop('disabled', true);
						$skipEndButton.prop('disabled', true);
					} else if (!dmak.state.isRendering) {
						toggleControls(
							dmak.timeouts.drawing,
							'[data-disable-while-drawing]',
						);
					}

					$pauseButton.addClass(hidePlayPauseClass);

					if (dmak.pointer === dmak.strokes.length) {
						$playButton.addClass(hidePlayPauseClass);
						$replayButton.removeClass(hidePlayPauseClass);
					} else {
						$playButton.removeClass(hidePlayPauseClass);
						$replayButton.addClass(hidePlayPauseClass);
					}
				},
				loaded: function () {
					var total_strokes = dmak.strokes.length;

					$slider.attr('max', total_strokes);
					$slider.data('prev', total_strokes); // Cache starting value

					// "Autoplay stroke order from start" in Kanji Settings window
					if (settings.stroke_order_autoplay) {
						dmak.render(total_strokes);
					} else {
						// Draw all strokes at once for quick rendering
						dmak.render(total_strokes, true); // simultaneous = true
					}

					// Important for the lookup browser, lest notches accumulate
					$notchContainer.empty();

					// +1 to include notch at the "0" stroke mark
					for (var i = 0; i < total_strokes + 1; i++) {
						$notchContainer.append($('<span class="slider-notch"></span>'));
					}

					$slider.on('change', function (event) {
						// Forced typecasting necessary to retain consistent performance
						// in Anki - likely a relic of the Anki JS/browser version !! dont change !!
						var stroke_num = parseInt($slider.val().toString()),
							prev_stroke_num = parseInt($slider.data('prev').toString()),
							shouldErase = $(this).val() < $slider.data('prev'),
							shouldDraw = $(this).val() > $slider.data('prev'),
							didAct = false;

						// Erase/draw as appropriate, to the selected stroke
						if (shouldErase || shouldDraw) {
							didAct = true;

							if (shouldErase) {
								dmak.erase(stroke_num);
							} else if (shouldDraw) {
								dmak.render(stroke_num, true);
							}
						}

						if (didAct) {
							// Save the currently selected stroke for next comparison
							$slider.data('prev', stroke_num);
						} else {
							// Proactively prevent any visual side-effects if somehow
							// the slider value change doesn't trigger dmak draw/erase
							$slider.val(prev_stroke_num);
						}
					});
				},
			});

			// CHANGES - END - stroke order diagram
			// ==================================================================

			$('.fontExample').html(data.character);

			tags = [];
			if (data.frequency_rank < 999999)
				tags.push('Frequency #' + data.frequency_rank.toString());
			if (data.jlpt !== null) tags.push('JLPT N' + data.jlpt.toString());
			if (data.kanken !== null) tags.push('Kanken ' + data.kanken.toString());
			if (data.grade !== null) {
				const num_conv = '０１２３４５６７８９';
				if (data.grade <= 6) tags.push('小学校' + num_conv[data.grade] + '年');
				if (data.grade == 8) tags.push('中学年');
				if (data.grade <= 8) tags.push('常用');
				if (data.grade >= 9 && data.grade <= 10) tags.push('人名用');
			}
			if (data.heisig_id5 !== null)
				tags.push('RTK (1-5) ' + data.heisig_id5.toString());
			if (data.heisig_id6 !== null)
				tags.push('RTK (6+) ' + data.heisig_id6.toString());
			$('.tags').html(wrap_list(tags, '<div class="tag">', '</div>', false));

			$('#onyomi').html(data.onyomi.length ? data.onyomi.join(', ') : '-');
			$('#kunyomi').html(data.kunyomi.length ? data.kunyomi.join(', ') : '-');
			$('#nanori').html(data.nanori.length ? data.nanori.join(', ') : '-');

			var has_primitives =
				data.primitives.length > 0 &&
				!(data.primitives.length == 1 && data.primitives[0] == data.character);
			$('.KanjiLookup-primitives').toggle(has_primitives);
			$('#primitives').empty();

			if (has_primitives) {
				var primitives_pts = [];

				for (const p_data of data.primitives_detail) {
					var keywords = [];
					if (p_data.usr_keyword) keywords.push(p_data.usr_keyword);
					if (
						p_data.heisig_keyword5 &&
						!keywords.includes(p_data.heisig_keyword5)
					)
						keywords.push(p_data.heisig_keyword5);
					if (
						p_data.heisig_keyword6 &&
						!keywords.includes(p_data.heisig_keyword6)
					)
						keywords.push(p_data.heisig_keyword6);
					for (const pk of p_data.primitive_keywords)
						keywords.push('<span class="primitive_keyword">' + pk + '</span>');
					var keywords_txt = keywords.length ? keywords.join(', ') : '-';

					var meanings_txt = p_data.meanings.length
						? p_data.meanings.join(', ')
						: '-';

					var primitive_alternatives_txt = p_data.primitive_alternatives.length
						? p_data.primitive_alternatives.join(', ')
						: '-';

					primitives_pts.push(
						'<button class="primitive" data-character="' +
							p_data.character +
							'">' +
							p_data.character +
							'<div class="primitiveDetails">' +
							'<div class="primitiveDetails-keywords"><h3>Keywords:</h3> ' +
							keywords_txt +
							'</div>' +
							'<div class="primitiveDetails-meanings"><h3>Meanings:</h3> ' +
							meanings_txt +
							'</div>' +
							'<div class="primitiveDetails-alternatives"><h3>Alternatives:</h3> ' +
							primitive_alternatives_txt +
							'</div>' +
							'</div></button>',
					);
				}

				$('#primitives').html(primitives_pts.join(''));

				$('.primitive').click(primitive_click);
			}

			var max_words = 20;
			word_pts = [];

			for (var i = 0; i < data.words.length; i++) {
				if (word_pts.length >= max_words) break;

				const we = data.words[i];
				const w = we[0];
				const r = we[1];

				word_pts.push(
					'<button class="word" data-word-kanji="' +
						w +
						'" data-word-idx="' +
						i +
						'"><ruby>' +
						w +
						'<rt>' +
						r +
						'</rt></ruby></button>',
				);
			}
			for (var i = 0; i < data.words_default.length; i++) {
				if (word_pts.length >= max_words) break;

				const we = data.words_default[i];
				const w = we[0];
				const r = we[1];

				if (
					data.words.some(function (existing_we) {
						return w == existing_we[0] && r == existing_we[1];
					})
				)
					continue;

				word_pts.push(
					'<button class="word word_default" data-word-kanji="' +
						w +
						'"><ruby>' +
						w +
						'<rt>' +
						r +
						'</rt></ruby></button>',
				);
			}
			$('.KanjiLookup-words').toggle(word_pts.length > 0);
			$('#words').html(word_pts.join(''));
			$('#words').toggleClass('hide_readings_hover', settings.hide_readings_hover);
			$('.word').click(word_click);

			$('.KanjiLookup-radicals').toggle(data.radicals.length > 0);
			$('#radicals').html(
				wrap_list(data.radicals, '<button class="radical">', '</button>'),
			);

			var keywords = [];
			if (data.usr_keyword) keywords.push(data.usr_keyword);
			if (data.heisig_keyword5 && !keywords.includes(data.heisig_keyword5))
				keywords.push(data.heisig_keyword5);
			if (data.heisig_keyword6 && !keywords.includes(data.heisig_keyword6))
				keywords.push(data.heisig_keyword6);
			for (const pk of data.primitive_keywords)
				keywords.push('<span class="primitive_keyword">' + pk + '</span>');
			$('#keywords').html(keywords.length ? keywords.join(', ') : '-');

			$('#meanings').html(
				data.meanings.length ? data.meanings.join(', ') : '-',
			);

			var stories = [];
			if (data.usr_story) stories.push(data.usr_story.split('\n').join('<br>'));
			if (data.heisig_story) {
				var heisig_story = data.heisig_story;
				if (data.heisig_comment)
					heisig_story += '<br><br>' + data.heisig_comment;
				stories.push(heisig_story);
			}
			for (const ks of data.koohi_stories) stories.push(ks);

			$('#stories').html(wrap_list(stories, '<p class="story">', '</p>'));

			function setup_card_btn(id, data, name) {
				txt = '';
				title = null;
				if (data === null) {
					txt = 'Create ' + name + ' Card';
					title = 'Shift click to mark as known';
				}
				if (data > 0) txt = 'Show ' + name + ' Card';
				if (data < 0) txt = 'Unmark ' + name + ' as known';

				$(id).html(txt);
				$(id).prop('title', title);
			}

			setup_card_btn(
				'#recognition_card_btn',
				data.recognition_card_id,
				'Recognition',
			);
			setup_card_btn(
				'#production_card_btn',
				data.production_card_id,
				'Production',
			);
		}
	}
</script>
<!-- END - Addon script, Lookup -->

<!-- ======================
END - Migaku markup
======================= -->
